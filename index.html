<!-- index.html (FINAL, DUAL-MODE WITH RESULTS DISPLAY) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Sea AI - eDNA Pipeline</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/framer-motion@4.1.17/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; }
        .main-gradient-text { background: linear-gradient(to right, #7DD3FC, #38BDF8, #0EA5E9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .team-gradient-text { background: linear-gradient(to right, #fb923c, #facc15, #fde047); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { motion, AnimatePresence } = Motion;

        // Use a relative path so it works on any server (Render, Hugging Face, etc.)
        const API_BASE_URL = ""; 

        function App() {
            const [activeTab, setActiveTab] = useState('batch');
            // Re-run createIcons when the tab changes to render new icons
            useEffect(() => {
                const timer = setTimeout(() => lucide.createIcons(), 0);
                return () => clearTimeout(timer);
            }, [activeTab]);

            const TabButton = ({ id, children, icon }) => (
                <button
                    onClick={() => setActiveTab(id)}
                    className={`flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-t-lg transition-all duration-300 ${
                        activeTab === id
                            ? 'bg-slate-800/80 text-sky-400 border-b-2 border-sky-400'
                            : 'text-slate-400 hover:text-white hover:bg-slate-800/40'
                    }`}
                >
                    <i data-lucide={icon} className="w-4 h-4"></i>
                    {children}
                </button>
            );

            return (
                <div className="relative min-h-screen w-full flex items-center justify-center p-4 bg-slate-950 text-white overflow-hidden">
                    <div className="absolute top-0 left-0 -translate-x-1/3 -translate-y-1/3 w-[600px] h-[600px] bg-sky-500/10 rounded-full blur-3xl"></div>
                    <div className="absolute bottom-0 right-0 translate-x-1/3 translate-y-1/3 w-[600px] h-[600px] bg-indigo-500/10 rounded-full blur-3xl"></div>
                    <motion.div 
                        initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.8 }}
                        className="relative z-10 w-full max-w-4xl bg-slate-900/50 backdrop-blur-md border border-sky-500/20 rounded-2xl shadow-2xl shadow-sky-900/50"
                    >
                        <div className="text-center p-8 border-b border-sky-500/10">
                            <i data-lucide="helix" className="w-16 h-16 mx-auto main-gradient-text"></i>
                            <h1 className="text-4xl md:text-5xl font-extrabold main-gradient-text mt-4">Deep Sea AI</h1>
                            <p className="text-sky-300/80 mt-2">Adaptive eDNA Analysis Pipeline</p>
                        </div>

                        <div className="border-b border-sky-500/10 px-8 pt-4">
                            <div className="flex space-x-2">
                                <TabButton id="batch" icon="file-stack">Batch File Analysis</TabButton>
                                <TabButton id="single" icon="file-scan">Single Sequence Analysis</TabButton>
                            </div>
                        </div>

                        <div className="p-8">
                            <AnimatePresence exitBeforeEnter>
                                {activeTab === 'batch' && <BatchFilePanel key="batch" />}
                                {activeTab === 'single' && <SingleSequencePanel key="single" />}
                            </AnimatePresence>
                        </div>
                         <div className="text-center p-4 border-t border-sky-500/10">
                            <p className="text-sm text-slate-500">
                                Created by <span className="font-bold team-gradient-text">AIgnition</span>
                            </p>
                        </div>
                    </motion.div>
                </div>
            );
        }
        
        // --- Component for Single Sequence Analysis ---
        function SingleSequencePanel() {
             const [sequence, setSequence] = useState("");
             const [result, setResult] = useState(null);
             const [isLoading, setIsLoading] = useState(false);
             const [error, setError] = useState(null);

             const handleAnalysis = async () => {
                if (!sequence.trim()) { setError("Please enter a DNA sequence."); return; }
                setIsLoading(true); setResult(null); setError(null);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/predict_single`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sequence: sequence.toUpperCase().replace(/\s/g, '') })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.detail || "Prediction failed.");
                    setResult(data);
                } catch (err) {
                    setError(`Analysis failed. ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
             };

             return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-6">
                    <textarea 
                        value={sequence}
                        onChange={(e) => setSequence(e.target.value)}
                        placeholder="Paste a single raw DNA sequence here (e.g., GTAGTGTACCTTTGTCGGTA...)"
                        rows="6"
                        className="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg placeholder:text-slate-500 text-sm font-mono focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition"
                    ></textarea>
                    <button onClick={handleAnalysis} disabled={isLoading || !sequence} className="w-full py-3 px-6 bg-sky-600 text-white font-semibold rounded-lg shadow-lg shadow-sky-600/30 hover:bg-sky-500 transition-all duration-300 transform hover:scale-105 disabled:bg-slate-700 disabled:cursor-not-allowed">
                        {isLoading ? 'Analyzing...' : 'Analyze Sequence'}
                    </button>
                    <AnimatePresence>
                        {error && <div className="text-center text-red-400 bg-red-900/50 p-3 rounded-lg">{error}</div>}
                        {result && (
                             <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="pt-6 border-t border-sky-500/10">
                                <h3 className="text-2xl font-bold main-gradient-text mb-4">Prediction Result</h3>
                                <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700 space-y-2">
                                    <div className="flex justify-between items-baseline">
                                        <p className="text-slate-400 text-sm">Predicted Genus / Cluster</p>
                                        <p className={`text-xs font-bold px-2 py-1 rounded-full ${result.decision === 'ACCEPTED' ? 'bg-green-900 text-green-300' : 'bg-yellow-900 text-yellow-300'}`}>{result.decision}</p>
                                    </div>
                                    <p className={`text-2xl font-bold ${result.decision === 'ACCEPTED' ? 'text-green-400' : 'text-yellow-400'}`}>{result.final_label}</p>
                                    
                                    {result.confidence && (
                                        <div className="flex justify-between items-baseline pt-2 border-t border-slate-700 mt-2">
                                            <p className="text-slate-400 text-sm">Confidence</p>
                                            <p className="text-lg font-semibold text-sky-300">{(result.confidence * 100).toFixed(2)}%</p>
                                        </div>
                                    )}
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </motion.div>
             )
        }

        // --- Component for Batch File Analysis ---
        function BatchFilePanel() {
            // This is the same component from your code, with the results display correctly integrated.
            const [file, setFile] = useState(null);
            const [result, setResult] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [topN, setTopN] = useState(3);
            const [loadingMessage, setLoadingMessage] = useState("Processing...");

            const handleFileChange = (event) => {
                setFile(event.target.files[0]);
                setResult(null); setError(null);
            };

            const handleAnalysis = async () => {
                if (!file) { setError("Please select a FASTA file."); return; }
                setIsLoading(true); setResult(null); setError(null);
                const formData = new FormData();
                formData.append('file', file);
                
                setLoadingMessage("Classifying sequences with hybrid AI...");
                const analysisUrl = `${API_BASE_URL}/process_fasta?top_n=${topN}`;

                try {
                    const response = await fetch(analysisUrl, { method: 'POST', body: formData });
                    if (response.ok) {
                         setLoadingMessage("Running live BLAST queries... (this can be slow)");
                    }
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.detail || `Server error: ${response.statusText}`);
                    }
                    setResult(data);
                } catch (err) { setError(`Analysis failed. ${err.message}`); } 
                finally { setIsLoading(false); }
            };
            
            const handleDownload = () => { window.open(`${API_BASE_URL}/download_csv`, '_blank'); };

            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div className="md:col-span-2">
                             <label htmlFor="fasta-file" className="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-700 border-dashed rounded-lg cursor-pointer bg-slate-800/60 hover:bg-slate-800/80 transition">
                                <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i data-lucide="upload-cloud" className="w-10 h-10 mb-3 text-slate-400"></i>
                                    <p className="mb-2 text-sm text-slate-400"><span className="font-semibold">Click to upload</span> or drag and drop</p>
                                    <p className="text-xs text-slate-500">FASTA file (.fasta, .fa)</p>
                                </div>
                                <input id="fasta-file" type="file" className="hidden" onChange={handleFileChange} accept=".fasta,.fa,.fna"/>
                            </label>
                            {file && <p className="text-center mt-2 text-sky-400 text-sm">Selected file: {file.name}</p>}
                        </div>
                        <div className="space-y-2">
                             <label htmlFor="top-n" className="block text-sm font-medium text-slate-400">Annotate Top N OTUs</label>
                             <input type="number" id="top-n" value={topN} onChange={(e) => setTopN(e.target.value)} min="1" max="5" className="w-full p-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-center focus:ring-2 focus:ring-sky-500 focus:border-sky-500"/>
                        </div>
                    </div>
                    <button onClick={handleAnalysis} disabled={isLoading || !file} className="w-full py-3 px-6 bg-sky-600 text-white font-semibold rounded-lg shadow-lg shadow-sky-600/30 hover:bg-sky-500 transition-all duration-300 transform hover:scale-105 disabled:bg-slate-700 disabled:cursor-not-allowed">
                        {isLoading ? loadingMessage : 'Run Full Pipeline'}
                    </button>
                    
                    <AnimatePresence>
                        {error && <div className="text-center text-red-400 bg-red-900/50 p-3 rounded-lg">{error}</div>}
                        {result && (
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="space-y-8 pt-6 border-t border-sky-500/10">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-2xl font-bold main-gradient-text">Analysis Complete</h3>
                                    <button onClick={handleDownload} className="flex items-center gap-2 py-2 px-4 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-500 transition-colors">
                                        <i data-lucide="download" className="w-4 h-4"></i> Download CSV
                                    </button>
                                </div>
                                <SummaryMetrics metrics={result.summary_metrics} />
                                {result.annotation_report && result.annotation_report.length > 0 && 
                                    <AnnotationReport annotations={result.annotation_report} />
                                }
                                <ExplainabilityReport results={result.detailed_results} />
                            </motion.div>
                        )}
                    </AnimatePresence>
                </motion.div>
            );
        }
        
        // These are the result display components from your original code
        const SummaryMetrics = ({ metrics }) => (
            <div>
                <h3 className="text-lg font-bold main-gradient-text mb-4">Batch Summary</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                        <p className="text-slate-400 text-sm">Total Sequences</p>
                        <p className="text-3xl font-bold text-white">{metrics.total_sequences}</p>
                    </div>
                    <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                        <p className="text-slate-400 text-sm">Known Taxa Detected</p>
                        <p className="text-3xl font-bold text-green-400">{metrics.known_taxa_detected}</p>
                    </div>
                    <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                        <p className="text-slate-400 text-sm">Novel OTUs Detected</p>
                        <p className="text-3xl font-bold text-yellow-400">{metrics.novel_otus_detected}</p>
                    </div>
                </div>
            </div>
        );

        const AnnotationReport = ({ annotations }) => (
            <div>
                <h3 className="text-lg font-bold main-gradient-text mb-4">Novel OTU Annotation (Top {annotations.length})</h3>
                <div className="space-y-3">
                    {annotations.map(item => (
                        <div key={item.otu_label} className="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                            <div className="flex justify-between items-center">
                                <p className="font-bold text-yellow-400">{item.otu_label}</p>
                                <p className="text-xs text-slate-400 font-mono">Count: {item.count}</p>
                            </div>
                            <p className="text-slate-300 mt-2 text-sm break-all">
                                <span className="font-semibold text-sky-400">Top BLAST Hit:</span> {item.top_blast_hit}
                            </p>
                        </div>
                    ))}
                </div>
            </div>
        );
        
        function ExplainabilityReport({ results }) {
            const [searchTerm, setSearchTerm] = useState("");
            const filteredResults = useMemo(() => {
                if (!searchTerm) return results;
                return results.filter(item => 
                    item.sequence_id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.final_label.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [searchTerm, results]);

            return (
                 <div>
                    <h3 className="text-lg font-bold main-gradient-text mb-4">Explainable AI Report</h3>
                    <input 
                        type="text" 
                        placeholder="Filter results by ID or label..." 
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full p-2 mb-4 bg-slate-800 border border-slate-700 rounded-lg placeholder:text-slate-500 focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                    />
                    <div className="max-h-80 overflow-y-auto bg-slate-800/50 p-1 rounded-lg border border-slate-700">
                        <table className="w-full text-left text-sm table-fixed">
                            <thead className="sticky top-0 bg-slate-800/80 backdrop-blur-sm">
                                <tr className="border-b border-slate-600">
                                    <th className="p-2 w-1/4">Sequence ID</th>
                                    <th className="p-2 w-1/4">Final Label</th>
                                    <th className="p-2 w-1/6">Decision</th>
                                    <th className="p-2 w-1/4">Top Candidate (Conf)</th>
                                    <th className="p-2 w-1/6">Ratio (Thresh)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredResults.map(item => (
                                    <tr key={item.sequence_id} className="border-b border-slate-700/50 hover:bg-slate-700/20">
                                        <td className="p-2 font-mono text-slate-400 truncate">{item.sequence_id}</td>
                                        <td className={`p-2 font-bold truncate ${item.decision === 'ACCEPTED' ? 'text-green-400' : 'text-yellow-400'}`}>{item.final_label}</td>
                                        <td className={`p-2 font-semibold ${item.decision === 'ACCEPTED' ? 'text-green-500' : 'text-yellow-500'}`}>{item.decision}</td>
                                        <td className="p-2 truncate">{item.top_candidate} <span className="text-xs text-slate-400">({(item.confidence * 100).toFixed(2)}%)</span></td>
                                        <td className="p-2 font-mono">{item.decision_metric_ratio.toFixed(2)} <span className="text-xs text-slate-400">({item.decision_threshold.toFixed(2)})</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
